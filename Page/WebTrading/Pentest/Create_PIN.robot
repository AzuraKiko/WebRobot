*** Settings ***
Resource    ../../../Locator/LoginLocator.robot
Resource    ../../../Utils/Common.robot
Resource    ../../../Page/WebTrading/Pentest/Log_out.robot
Resource    ../../WebAdmin/Pentest/Forgot_Pin.robot


*** Variables ***
${popup_Set_Pin}            //*[@class="pinFormRoot fadeInAnimation qe-firstPinForm"]//span[text()='Set Your PIN']
${popup_Confirm_Pin}        //*[@class="pinFormRoot fadeInAnimation qe-firstPinForm"]//span[text()='Confirm Your New PIN']
${popup_Enter_Pin}          //*[@class="pinFormRoot fadeInAnimation qe-firstPinForm"]//span[text()='Enter Your PIN']
${textbox_Pin}              //*[contains(@class,"symbolPrivatePinCode")]
${textbox_Confirm_Pin}      (//*[@class="pinFormInput"])[2]//*[contains(@class,"symbolPrivatePinCode")]
${icon_Max}                 //*[@title="Maximise"]
${button_Next}              //*[@id="pinDoneButton"][text()='next']
${button_Back}              //*[@class="button match undefined"][text()='back']
${button_Done}              //*[@id="pinDoneButton"][text()='done']
${error_Confirm_PIN}        (//*[@class='pinFormAlert size--3'])[2]
${error_Enter_PIN}          //*[@class="pinFormAtten size--3"]//div[contains(@class,'pinFormAlert')]
${popup_Logout}             //*[@class="popUpLogout myShow popup isPinForm"]
${forgot_Pin}               //*[@class="forgotPIN"]
${button_OK}                (//*[contains(@class,'btn size--4')])[2]
${key_Delete}               //*[@fill="var(--secondary-default)"]
${key_Delete_New_Pin}       //*[contains(@class,"pinFormRoot fadeInAnimation ")]//*[@fill="var(--secondary-default)"]
${textbox_Pass_Pin}         //*[@id="userInputPassword"]
${button_Cancel}            //*[text()='cancel']
${popup_Reset_Pin}          //*[@class="rightSettings resetPinRow fadeInAnimation"]//*[text()='Reset Your PIN']
${button_Submit}            //*[@id="submitButton"]
${error_Network}            //*[@class="networkErrorAlert"]
${error_Session}            //*[@class="sessionErrorAlert"]
${error_Concurrent}         //*[@class="concurrentSessionAlert"]


*** Keywords ***
Login successful Web Trading
    [Arguments]    ${username}    ${password}
    Wait Until Element Is Visible    ${icon_Max}    timeout=30s
    Click Sign In link
    Input textbox Email in Trading    ${username}
    Input textbox Password in Trading    ${password}
    Click button [Sign In]

Verify popup Set PIN display
    Verify element display    ${popup_Set_Pin}

Verify popup Reset PIN display
    Verify element display    ${popup_Reset_Pin}

Verify popup Confirm PIN display
    Verify element display    ${popup_Confirm_Pin}

Verify popup Enter PIN display
    Verify element display    ${popup_Enter_Pin}

Input PIN
    [Arguments]    ${character}
    Wait Until Element Is Visible    ${textbox_Pin}    20s
    FOR    ${i}    IN RANGE    0    6
        Click To Element    ${key_Delete}
    END
    Press Keys    ${None}    ${character}

Input Confirm PIN
    [Arguments]    ${character}
    Wait Until Element Is Visible    ${textbox_Confirm_Pin}    20s
    sleep    1s
    FOR    ${i}    IN RANGE    0    6
        Click To Element    ${key_Delete_New_Pin}
    END
    Press Keys    ${None}    ${character}

Verify textbox Enter PIN receive
    [Arguments]    ${number_text_receive_expected}
    IF    ${number_text_receive_expected} == 0
        Log To Console    i la 0
    ELSE
        FOR    ${i}    IN RANGE    1    ${number_text_receive_expected}
            ${text}=    Get Element Attribute    (${textbox_Pin})[${i}]    class
            ${text}=    Strip String    ${text}
            Should Be Equal    ${text}    symbolPrivatePinCode filled
        END
        ${number}=    Evaluate    6-${number_text_receive_expected}
        IF    ${number} == 0
            Log To Console    i la 0
        ELSE IF    ${number} == 1
            ${text}=    Get Element Attribute    (${textbox_Pin})[6]    class
            ${text}=    Strip String    ${text}
            Should Be Equal    ${text}    symbolPrivatePinCode
        ELSE
            FOR    ${i}    IN RANGE    1    ${number}
                ${i}=    Evaluate    6-${i}
                ${text}=    Get Element Attribute    (${textbox_Pin})[${i}]    class
                ${text}=    Strip String    ${text}
                Should Be Equal    ${text}    symbolPrivatePinCode
            END
        END
    END

Verify button [Next] disable
    Verify button disable    ${button_Next}

Verify button [Next] enable
    Verify button enable    ${button_Next}

Verify button [Back] enable
    Verify button disable/enable by JS    ${button_Back}    pointer

Click button [Back]
    Click To Element    ${button_Back}

Click button [Next]
    Click To Element    ${button_Next}

Click button [Done]
    Click To Element    ${button_Done}

Verify message error Confirm PIN
    [Arguments]    ${text_Expected}
    Wait Until Element Is Visible    ${error_Confirm_PIN}
    ${text_Actual}=    Get Text    ${error_Confirm_PIN}
    ${text_Actual}=    Strip String    ${text_Actual}
    Should Be Equal    ${text_Expected}    ${text_Actual}

Verify enter PIN success
    Wait Until Element Is Not Visible    ${popup_Enter_Pin}    30s
    Element Should Not Be Visible    ${popup_Enter_Pin}

Verify message error Enter PIN
    [Arguments]    ${text_Expected}
    Wait Until Element Is Visible    ${error_Enter_PIN}
    ${text_Actual}=    Get Text    ${error_Enter_PIN}
    ${text_Actual}=    Strip String    ${text_Actual}
    Should Be Equal    ${text_Expected}    ${text_Actual}

Verify popup Logout display
    Verify element display    ${popup_Logout}

Click Forgot PIN
    Click To Element    ${forgot_Pin}

Verify textbox Password blank
    Wait Until Element Is Visible    ${textbox_Pass_Pin}
    ${text}=    Get Element Attribute    ${textbox_Pass_Pin}    value
    Should Be Equal    ${text}    ${EMPTY}

Verify button Cancel enable
    Verify button disable/enable by JS    ${button_Cancel}    pointer

Verify button OK enable
    Verify button disable/enable by JS    ${button_OK}    pointer

# New Keywords for Advanced Test Cases

Verify PIN format validation
    [Arguments]    ${pin}    ${expected_error}
    Input PIN    ${pin}
    Verify message error Enter PIN    ${expected_error}

Verify PIN strength requirements
    [Arguments]    ${pin}    ${expected_error}
    Input PIN    ${pin}
    Verify message error Enter PIN    ${expected_error}

Simulate Network Timeout
    Execute JavaScript    window.performance.setResourceTimingBufferSize(0)
    Sleep    5s
    Execute JavaScript    window.performance.setResourceTimingBufferSize(250)

Simulate Session Expiry
    Execute JavaScript    localStorage.clear()
    Execute JavaScript    sessionStorage.clear()
    Reload Page

Open Second Session
    Execute JavaScript    window.open('${URL}', '_blank')
    Switch Window    NEW
    Maximize Browser Window

Verify Network Error
    [Arguments]    ${expected_error}
    Wait Until Element Is Visible    ${error_Network}
    ${text_Actual}=    Get Text    ${error_Network}
    Should Be Equal    ${expected_error}    ${text_Actual}

Verify Session Error
    [Arguments]    ${expected_error}
    Wait Until Element Is Visible    ${error_Session}
    ${text_Actual}=    Get Text    ${error_Session}
    Should Be Equal    ${expected_error}    ${text_Actual}

Verify Concurrent Session Error
    [Arguments]    ${expected_error}
    Wait Until Element Is Visible    ${error_Concurrent}
    ${text_Actual}=    Get Text    ${error_Concurrent}
    Should Be Equal    ${expected_error}    ${text_Actual}
