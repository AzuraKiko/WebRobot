*** Settings ***
Resource    ../../../Page/WebTrading/Pentest/LoginPage.robot
Resource    ../../../Locator/OrderLocator.robot


*** Variables ***
${option_Portfolio}                 //*[@id="menu-7"]
${option_Portfolio_Summary}         //*[@id="menu-7-1"]
${Transaction_Not_Block}            //*[@class="itemLeft"]
${Field_Transaction_Not_Block}      (//*[text()='CHANGE_ME']//parent::div//parent::div[@class="itemLeft"]//following-sibling::div)[4]
${T0}                               (//*[@class="itemLeft firstLetterUpperCase itemToggle showTitle"])[1]
${T1}                               (//*[@class="itemLeft firstLetterUpperCase itemToggle showTitle"])[2]
${T2}                               (//*[@class="itemLeft firstLetterUpperCase itemToggle showTitle"])[3]
${Pending_Settlement_Field}         //*[text()='pending settlement']//parent::div[@class="toggleSub"]
${textbox_Search_Account}           //*[contains(@class,'searchAccountContainer')]//input
${First_Option_In_Dropdown}         (//*[@class="itemSuggest searchAllAccounts showTitle"])[1]
${loading}                          //*[@class="lm_tab lm_active loading theme-dark"]
${Field_By_Text1}                   (//*[@id="accountSummary"]//*[text()='CHANGE_ME']//following-sibling::div//div)[2]
${Field_By_Text2}                   //*[@id="accountSummary"]//*[text()='CHANGE_ME']//following-sibling::div//div


*** Keywords ***
Open Portfolio Summary
    Hover To Element    ${leftHumbergerMenu}
    Hover To Element    ${option_Portfolio}
    Click To Element    ${option_Portfolio_Summary}

Click Transaction not block
    Click To Element    ${Transaction_Not_Block}

Verify T0, T1, T2 display
    Verify element display    ${T0}
    Verify element display    ${T1}
    Verify element display    ${T2}

Verify T0, T1, T2 not display
    Verify Element Not Display    ${Transaction_Not_Block}
    Verify Element Not Display    ${T0}
    Verify Element Not Display    ${T1}
    Verify Element Not Display    ${T2}

Verify Pending Settlement Field not display
    Verify Element Not Display    ${Pending_Settlement_Field}

Search Account Summary
    [Arguments]    ${text_Input}
    Select Autocomplete Dropdown    ${textbox_Search_Account}    ${First_Option_In_Dropdown}    ${text_Input}
    Wait Until Element Is Not Visible    ${loading}

Get Number By Text
    [Arguments]    ${locator_has_text}    ${text}    ${locator_field}=
    ${locator_field}=    Replace String    ${locator_has_text}    CHANGE_ME    ${text}
    ${value_field}=    Get Text    ${locator_field}

    # Use a broader regex to capture the entire number pattern
    ${matches}=    Get Regexp Matches    ${value_field}    -?\\$?\\d[\\d,]*\\.?\\d*
    ${matches_length}=    Get Length    ${matches}

    IF    ${matches_length} == 0
        Fail    Không tìm thấy số trong "${value_field}"
    END

    # Get the first match
    ${value}=    Get From List    ${matches}    0

    # Clean up the value
    ${value}=    Replace String    ${value}    ,    ${EMPTY}
    ${value}=    Replace String    ${value}    $    ${EMPTY}

    # Convert to number
    ${number}=    Convert To Number    ${value}

    RETURN    ${number}

Verify Trading Balance = Cash At Bank + Transaction not Booked
    ${Trading_Balance_Value}=    Get number by text    ${Field_By_Text2}    trading balance
    ${Cash_At_Bank_Value}=    Get number by text    ${Field_By_Text2}    Cash At Bank
    ${Transaction_not_Booked}=    Get number by text    ${Field_Transaction_Not_Block}    Transactions not Booked
    ${expected}=    Evaluate    ${Cash_At_Bank_Value} + ${Transaction_not_Booked}
    Should Be Equal    ${Trading_Balance_Value}    ${expected}
