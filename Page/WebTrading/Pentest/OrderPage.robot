*** Settings ***
Documentation       Order page keywords for trading operations

Library             SeleniumLibrary
Library             String
Resource            LoginPage.robot
Resource            ../../../Locator/OrderLocator.robot
Resource            Summary.robot


*** Keywords ***
# Navigation Keywords
Open New Order
    [Documentation]    Opens the new order page after login
    Login And Close All Tabs    ${username}    ${password}
    Hover To Element    ${leftHumbergerMenu}
    Hover To Element    ${leftTradingMenu}
    Click To Element    ${btnNewOrder}

# Account Input Keywords

Search Account
    [Documentation]    Inputs username in the account search field
    [Arguments]    ${account}
    Clear Text To Element    ${inputSearch_Account}
    Input Text To Element    ${inputSearch_Account}    ${account}
    Click To Element    ${suggestAccount}

# Symbol Input Keywords

Input Symbol
    [Documentation]    Generic keyword to input any symbol type
    [Arguments]    ${symbol_type}    ${symbol_value}
    Clear Text To Element    ${inputSearch_Symbol}
    Input Text To Element    ${inputSearch_Symbol}    ${symbol_value}
    Click To Element    ${clickSearch_${symbol_type}}

Input ETF
    [Documentation]    Inputs ETF symbol
    [Arguments]    ${etf}
    Input Symbol    etf    ${etf}

Input MF
    [Documentation]    Inputs Mutual Fund symbol
    [Arguments]    ${mf}
    Input Symbol    mf    ${mf}

Input Warrant
    [Documentation]    Inputs Warrant symbol
    [Arguments]    ${warrant}
    Input Symbol    warrant    ${warrant}

Input Option
    [Documentation]    Inputs Option symbol
    [Arguments]    ${option}
    Input Symbol    option    ${option}

Input Equity
    [Documentation]    Inputs Equity symbol
    [Arguments]    ${equity}
    Input Symbol    equity    ${equity}

# Order Type Selection Keywords

Select Order Type
    [Documentation]    Generic keyword to select order type
    [Arguments]    ${order_type}
    ${normalized}=    Convert To Lower Case    ${order_type}
    ${normalized}=    Replace String    ${normalized}    ${SPACE}    ''
    ${locator}=    Get Variable Value    ${clickOrderType_${normalized}}
    Select Fixed Value From Dropdown    ${clickSelectOderType}    ${locator}

Select Order Type Limit
    [Documentation]    Selects Limit order type
    Select Order Type    Limit

Select Order Type MarketToLimit
    [Documentation]    Selects Market to Limit order type
    Select Order Type    MarketToLimit

Select Order Type STOPLIMIT
    [Documentation]    Selects Stop Limit order type
    Select Order Type    StopLimit

# Order Details Input Keywords

Input Quantity
    [Documentation]    Inputs order quantity
    [Arguments]    ${quantity}
    Wait Until Element Is Visible    ${inputQuantity}    ${time}
    Clear Element Text    ${inputQuantity}
    Input Text    ${inputQuantity}    ${quantity}

Input Limit Price
    [Documentation]    Inputs limit price
    [Arguments]    ${price}
    Wait Until Element Is Visible    ${inputLimitPrice}    ${time}
    Clear Element Text    ${inputLimitPrice}
    Input Text    ${inputLimitPrice}    ${price}

Input Trigger Price
    [Documentation]    Inputs trigger price for stop orders
    [Arguments]    ${trigger_price}
    Wait Until Element Is Visible    ${inputTriggerPrice}    ${time}
    Clear Element Text    ${inputTriggerPrice}
    Input Text    ${inputTriggerPrice}    ${trigger_price}

# Duration Selection Keywords

Select Duration
    [Documentation]    Generic keyword to select duration
    [Arguments]    ${duration}
    Wait Until Element Is Visible    ${clickSelectDuration}
    Click Element    ${clickSelectDuration}
    Wait Until Element Is Visible    ${clickSelectDuration_${duration}}
    Click Element    ${clickSelectDuration_${duration}}

Select Duration GTC
    [Documentation]    Selects Good Till Cancelled duration
    Select Duration    GTC

Select Duration DO
    [Documentation]    Selects Day Only duration
    Select Duration    DayOnly

Select Duration GTD
    [Documentation]    Selects Good Till Date duration
    Select Duration    GTD

Select Duration FOK
    [Documentation]    Selects Fill or Kill duration
    Select Duration    FOK

Select Duration IOC
    [Documentation]    Selects Immediate or Cancel duration
    Select Duration    IOC

# Destination Selection Keywords

Select Destination
    [Documentation]    Generic keyword to select destination
    [Arguments]    ${destination}
    Wait Until Element Is Visible    ${clickDestination}
    Click Element    ${clickDestination}
    Wait Until Element Is Visible    ${clickdestination_${destination}}
    Click Element    ${clickdestination_${destination}}

Select Destination BESTMARKET
    [Documentation]    Selects BESTMARKET destination
    Select Destination    BESTMKT

Select Destination ASX
    [Documentation]    Selects ASX destination
    Select Destination    ASX

Select Destination ASXCP
    [Documentation]    Selects ASXCP destination
    Select Destination    ASXCP

Select Destination CXA
    [Documentation]    Selects CXA destination
    Select Destination    CXA

Select Destination qCXA
    [Documentation]    Selects qCXA destination
    Select Destination    qCXA

Select Destination qASX
    [Documentation]    Selects qCXA destination
    Select Destination    qASX

# Order Action Keywords

Click Review Order
    [Documentation]    Clicks review order button
    Click To Element    ${btnReviewOrder}

Click Place Buy Order
    [Documentation]    Places a buy order and verifies success
    Double Click Element    ${btnPlaceBuyOrder}
    Wait Until Page Contains    Place order successfully    ${time}

Click Place Buy Order Not Enough Cash
    [Documentation]    Places a buy order when not enough cash and validates
    Click Review Order
    Validate Buy When Not Enough Cash

Click Place Sell Order
    [Documentation]    Places a sell order and verifies success
    Double Click Element    ${btnPlaceSellOrder}
    Wait Until Page Contains    Place order successfully    ${time}

Click Sell
    [Documentation]    Clicks sell button
    Click To Element    ${sell}

# Order Verification Keywords

Verify Review Order
    [Documentation]    Verifies order review details
    [Arguments]
    ...    ${expected_account}
    ...    ${expected_side}
    ...    ${expected_order_type}
    ...    ${expected_symbol}
    ...    ${expected_duration}
    ...    ${expected_destination}
    Verify Text Element    ${accountID}    ${expected_account}
    Verify Text Element    ${side}    ${expected_side}
    Verify Text Element    ${orderType}    ${expected_order_type}
    Verify Text Element    ${symbol_locator}    ${expected_symbol}
    Verify Text Element    ${duration}    ${expected_duration}
    Verify Text Element    ${destination}    ${expected_destination}

# Order List Keywords

Click Orders List
    [Documentation]    Navigates to orders list
    Mouse Over    ${leftTradingMenu}
    Click To Element    ${menuOrdersList}

Search Orders List
    [Documentation]    Searches orders list for specific account
    [Arguments]    ${account}
    Clear Text By Key Delete    ${inputSearchOrderList}
    Input Text To Element    ${inputSearchOrderList}    ${account}
    Click To Element    ${inputSearch_Account}
    Click To Element    ${clickBtnSearch}

# Order Modification Keywords

Click Modify Order
    [Documentation]    Clicks modify order button
    Click To Element    ${btnModifyOrder}

Click Cancel Order
    [Documentation]    Clicks cancel order button
    Click To Element    ${btnCancelOrder}

Click Element If Visible
    [Documentation]    Clicks element if visible, otherwise clicks alternative
    [Arguments]    ${element1}    ${element2}
    ${isVisible}=    Run Keyword And Return Status    Element Should Be Visible    ${element1}
    IF    ${isVisible}
        Click To Element    ${element1}
    ELSE
        Click To Element    ${element2}
    END

Click Modify Buy Order
    [Documentation]    Clicks modify buy order button
    Drag And Drop By Offset    //div[contains(text(),'review order')]    200    -300
    Click Element If Visible    ${btnModifyBuyOrder}    ${btnModifySellOrder}

Click Cancel Order In Popup
    [Documentation]    Clicks cancel order in popup
    Click To Element    ${btnCancelOrderInPopup}

Click OK
    [Documentation]    Clicks OK button
    Click To Element    ${btnOK}

# Order List Navigation Keywords

Go To List Order
    [Documentation]    Navigates to order list
    Hover To Element    ${leftHumbergerMenu}
    Hover To Element    ${leftTradingMenu}
    Click To Element    ${menuOrdersList}

Search Class Filter
    [Documentation]    Searches orders by class filter
    [Arguments]    ${textFilter}
    Input Text To Element    ${quickFilter}    ${textFilter}
    Click To Element    ${btnGo}

Click Icon Detail Order
    [Documentation]    Clicks order detail icon
    Mouse Over    ${inputSearchOrderList}
    Double Click Element    ${inputSearchOrderList}
    Click Element At Coordinates    ${inputSearchOrderList}    2375    160
    Sleep    0.1s
    Click Element At Coordinates    ${inputSearchOrderList}    2375    160

Detail Order
    [Documentation]    Views order details
    [Arguments]    ${class}
    Go To List Order
    Search Account Summary    ${account}
    Search Class Filter    ${class}
    Click Icon Detail Order

Verify Detail Order
    [Documentation]    Verifies order details
    [Arguments]
    ...    ${expected_account}
    ...    ${expected_side}
    ...    ${expected_order_type}
    ...    ${expected_symbol}
    ...    ${expected_duration}
    ...    ${expected_destination}
    Element Should Not Contain    ${accountOfDetail}    ${expected_account}
    Verify Text Element    ${side}    ${expected_side}
    Verify Text Element    ${orderType}    ${expected_order_type}
    Verify Text Element    ${symbol_locator}    ${expected_symbol}
    Verify Text Element    ${duration}    ${expected_duration}
    Verify Text Element    ${destination}    ${expected_destination}

# Utility Keywords

Click Date Time Picker
    [Documentation]    Gets date from date time picker
    ${date}=    Get Text    ${clickDateTimePicker}
    Log    ${date}

Validate Buy When Not Enough Cash
    [Documentation]    Validates insufficient cash scenario
    ${balance}=    Get Number By Text    ${tradingBalanceStep1}    trading balance
    Log    ${balance}
    ${total}=    Get Number By Text    ${estimateTotal}    estimated total
    Log    ${total}
    IF    ${balance}<${total}
        Verify Text Element    ${errorReviewMessage}    Insufficient cash to trade
    END

Create Buy Order
    [Documentation]    Creates a buy order with given parameters
    [Arguments]    ${symbol_type}    ${symbol_value}    ${order_type}    ${duration}    ${destination}
    Search Account    ${account}
    Input Symbol    ${symbol_type}    ${symbol_value}
    Select Order Type    ${order_type}
    Input Quantity    ${quantity}
    IF    '${order_type}' == 'LIMIT' or '${order_type}' == 'STOP LIMIT'
        Input Limit Price    ${price}
    END
    IF    '${order_type}' == 'STOP LIMIT'
        Input trigger price    ${trigger_price}
    END
    Select Duration    ${duration}
    Sleep    2s
    Select Destination    ${destination}
    Click Review Order
    Verify Review Order    ${account}    ${BUY}    ${order_type}    ${symbol_value}    ${duration}    ${destination}
    Click Place Buy Order

Create Sell Order
    [Documentation]    Creates a buy order with given parameters
    [Arguments]    ${symbol_type}    ${symbol_value}    ${order_type}    ${duration}    ${destination}
    Search Account    ${account}
    Input Symbol    ${symbol_type}    ${symbol_value}
    Click Sell
    Select Order Type    ${order_type}
    Input Quantity    ${quantity}
    IF    '${order_type}' == 'LIMIT' or '${order_type}' == 'STOP LIMIT'
        Input Limit Price    ${price}
    END
    IF    '${order_type}' == 'STOP LIMIT'
        Input trigger price    ${trigger_price}
    END
    Select Duration    ${duration}
    Sleep    2s
    Select Destination    ${destination}
    Click Review Order
    Verify Review Order    ${account}    ${BUY}    ${order_type}    ${symbol_value}    ${duration}    ${destination}
    Click Place Buy Order

Verify Create Order Succesfully
    [Arguments]    ${side}    ${symbol_type}    ${symbol_value}    ${order_type}    ${duration}    ${destination}
    ${key_searchs}=    Split String    ${symbol_value}    .
    ${key_search}=    Set Variable    ${key_searchs}[0]
    Detail Order    ${key_search}
    Verify Detail Order    ${account}    ${side}    ${order_type}    ${symbol_value}    ${duration}    ${destination}
