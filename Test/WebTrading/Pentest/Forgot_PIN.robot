*** Settings ***
Resource    ../../../Page/WebTrading/Pentest/Forgot_PIN.robot


*** Variables ***
${new_username}     ${EMPTY}
${new_password}     ${EMPTY}
${new_user_id}      ${EMPTY}


*** Test Cases ***
# Password Confirmation Flow
Check incorrect password confirmation. Incorrect 1st time
    [Tags]    pentest
    Create New User For Testing
    Open Forgot PIN Popup    ${new_username}    ${new_password}
    Verify popup Reset PIN display
    Input textbox Password to confirm    123123123
    Click OK Button
    Verify error message Password in Reset PIN screen    Incorrect Password

Check incorrect password confirmation. Incorrect 2nd times
    [Tags]    pentest
    Click OK Button
    Verify Error Setting    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Time    300s

Check incorrect password confirmation. Incorrect 3rd times
    [Tags]    pentest
    Wait button OK enable
    Click OK Button
    Verify Error Setting    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Time    900s

Check incorrect password confirmation. Incorrect 4th times
    [Tags]    pentest
    Wait button OK enable
    Click OK Button
    Verify Error Setting    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Time    1800s

Check incorrect password confirmation. Incorrect 5th times
    [Tags]    pentest
    Wait button OK enable
    Click OK Button
    Verify Error Setting
    ...    Your username has been temporarily blocked for security reason. Please contact hello@equix.app for support.
    Close Browser
    ${token}=    Get Authentication Token
    ...    ${urlLogin}
    ...    ${other_username}
    ...    ${other_password}
    ...    ${originAdminPortal}
    ...    ${version}
    ...    ${environment}
    Update User Status    ${new_user_id}    2    ${token}

# Cancel Button Functionality

Check UI "Enter Your New" screen
    [Tags]    pentest
    Open Forgot PIN Popup    ${new_username}    ${new_password}
    Verify popup Reset PIN display
    Input textbox Password to confirm    ${new_password}
    Click OK Button
    Verify popup New Pin display
    Verify button [Next] disable
    Verify button [Cancel] enable

Check cancel button. when not count down
    [Tags]    pentest
    Click button [Cancel]
    Verify popup Reset PIN display
    Click Cancel Button
    Verify popup Enter PIN display

Check cancel button. When count down
    [Tags]    pentest
    Click Forgot PIN
    Input textbox Password to confirm    111111
    Click OK Button
    Input textbox Password to confirm    111111
    Click OK Button
    Click Cancel Button
    Verify popup Enter PIN display
    Close Browser

# PIN Confirmation Flow

Check UI "Confirm Your New PIN" screen
    [Tags]    pentest
    Open Forgot PIN Popup    ${new_username}    ${new_password}
    Input textbox Password to confirm    ${new_password}
    Click OK Button
    Verify popup New Pin display
    Input New PIN Of Forgot PIN Screen    ${pin}
    Verify popup Confirm New PIN display
    Input Confirm New PIN Of Forgot PIN Screen    ${pin}

Check Cancel/Next button in New PIN screen
    [Tags]    pentest
    Click button [Back]
    Verify popup Confirm New PIN display
    Verify button [Back] enable
    Verify button [Next] enable
    Click button [Back]
    Verify popup New Pin display
    Click button [Cancel]
    Verify popup Reset PIN display
    Input textbox Password to confirm    ${new_password}
    Click OK Button
    Input New PIN Of Forgot PIN Screen    ${pin}
    Verify popup Confirm New PIN display

Check input confirmation PIN different new PIN
    [Tags]    pentest
    Input Confirm New PIN Of Forgot PIN Screen    121212
    Verify button [Back] enable
    Verify button [Next] disable
    Verify message error Confirm PIN    PIN did not match. Try again

Check input confirmation PIN different new PIN x many times
    [Tags]    pentest
    Input Confirm New PIN Of Forgot PIN Screen    121212
    Verify message error Confirm PIN    PIN did not match. Try again
    Input Confirm New PIN Of Forgot PIN Screen    121212
    Verify message error Confirm PIN    PIN did not match. Try again
    Input Confirm New PIN Of Forgot PIN Screen    121212
    Verify message error Confirm PIN    PIN did not match. Try again

Check confirm PIN successfully
    [Tags]    pentest
    Sleep    2s
    Input Confirm New PIN Of Forgot PIN Screen    ${pin}
    Verify OTP screen display

Check Next button
    [Tags]    pentest
    Click button [Back]
    Click button [Next]
    Verify OTP screen display
    Close Browser

# OTP Verification Flow

Check UI OPT screen. Check UI default loading
    [Tags]    pentest
    Open Forgot PIN Popup    ${new_username}    ${new_password}
    Input textbox Password to confirm    ${new_password}
    Click OK Button
    Verify popup New Pin display
    Input New PIN Of Forgot PIN Screen    ${pin}
    Verify popup Confirm New PIN display
    Input Confirm New PIN Of Forgot PIN Screen    ${pin}
    Verify button [Back] enable
    Verify button [Send Code] enable
    Verify placeholder of textbox Enter Code
    Verify button [Confirm] disable

Check function. Click on Back button
    [Tags]    pentest
    Click button [Back]
    Verify popup Confirm New PIN display

Check function. Click on Send Code button
    [Tags]    pentest
    Click button [Next]
    Verify [Send Code] Button Disabled With Time    60s

Check validate OPT textbox. Check input special character/ Check input string type
    [Tags]    pentest
    Input textbox Enter Code    !@#$%^%
    Verify textbox Enter Code receive characters    ${EMPTY}
    Input textbox Enter Code    ABCdef
    Verify textbox Enter Code receive characters    ${EMPTY}

Check confirm button. Check input incorrect OPT 1st time
    [Tags]    pentest
    ${number}=    Random number    6
    Input textbox Enter Code    ${number}
    Click button Confirm
    Verify message Error Code    Incorrect verification code. Please retry again

Check confirm button. Check input incorrect OPT 2nd time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code    You have tried too many times. Please try again later.
    Verify button [Confirm] disable in time    300s

Check confirm button. Check input incorrect OPT 3rd time
    [Tags]    pentest
    Click button [Send Code]
    ${random_number}=    Random number    6
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code    You have tried too many times. Please try again later.
    Verify button [Confirm] disable in time    900s

Check confirm button. Check input incorrect OPT 4th time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    ${expected_message}=    Set Variable
    ...    Your login session has expired. Please try again

    FOR    ${i}    IN RANGE    100
        ${text}=    Get Element Text By JS    ${error_Code}
        Log    Current error message: ${text}
        ${status}=    Run Keyword And Return Status    Verify popup Reset PIN display

        IF    '${text}' == '${expected_message}' or ${status}
            Verify popup Reset PIN display
            Input textbox Password to confirm    ${new_password}
            Click OK Button
            Verify popup New Pin display
            Input New PIN Of Forgot PIN Screen    ${pin}
            Verify popup Confirm New PIN display
            Input Confirm New PIN Of Forgot PIN Screen    ${pin}
            BREAK
        END
        Sleep    1s
    END
    ${random_number}=    Random number    6
    Click button [Send Code]
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code    You have tried too many times. Please try again later.
    Verify button [Confirm] disable in time    1800s

Check confirm button. Check input incorrect OPT 5th time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    ${expected_message}=    Set Variable
    ...    Your login session has expired. Please try again

    FOR    ${i}    IN RANGE    100
        ${text}=    Get Element Text By JS    ${error_Code}
        Log    Current error message: ${text}
        ${status}=    Run Keyword And Return Status    Verify popup Reset PIN display

        IF    '${text}' == '${expected_message}' or ${status}
            Verify popup Reset PIN display
            Input textbox Password to confirm    ${new_password}
            Click OK Button
            Verify popup New Pin display
            Input New PIN Of Forgot PIN Screen    ${pin}
            Verify popup Confirm New PIN display
            Input Confirm New PIN Of Forgot PIN Screen    ${pin}
            BREAK
        END
        Sleep    1s
    END
    ${random_number}=    Random number    6
    Click button [Send Code]
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code
    ...    Your username has been temporarily blocked for security reason. Please contact hello@equix.app for support.
    Close Browser
    ${token}=    Get Authentication Token
    ...    ${urlLogin}
    ...    ${other_username}
    ...    ${other_password}
    ...    ${origin}
    ...    ${version}
    ...    ${environment}
    Update User Status    ${new_user_id}    2    ${token}

# Successful Forgot PIN Flow

Verify Successful Forgot PIN
    [Tags]    pentest
    Open Forgot PIN Popup    ${new_username}    ${new_password}
    Input textbox Password to confirm    ${new_password}
    Click OK Button
    Input New PIN Of Forgot PIN Screen    ${pin}
    Verify popup Confirm New PIN display
    Input Confirm New PIN Of Forgot PIN Screen    ${pin}
    Sleep    30s
    Input textbox Enter Code    ${pin}
    Sleep    20s
    Click button Confirm
    Verify message Confirm Bound    You have been automatically signed out for security reasons
    Click OK Popup Confirm
    Close Browser
