*** Settings ***
Resource    ../../../Page/WebTrading/Pentest/Change_Pass.robot
Resource    ../../../Utils/API.robot
# Test Setup    Open Change Password Popup
# Test Teardown    Close All Browsers


*** Variables ***
${255_chars_password}       ajhdshgfjlkbohkgfblvlkjjkcnjkfgljkkb;ghl;lvfjdkcvgjgvhjhvflbjdb;vgklhgkfljgkilvhsdukfdhgvgjgndkvbnjgbgngjgkfdjkhcffhdfgdhgdfgfghfhdjdfbfjdjdjsskafhkncbsgsgajajsjfbsgwjwhwbdfudjedhjqiaodkfjfbdgdeuweejdkdjddshsyeyehfhvhcgsshndnhfdhdhdhdhdhdffhufffhjfjkdsudsd
${valid_password}           Abc@12345


*** Test Cases ***
# Basic UI Tests
Check Change Password Screen Elements
    [Documentation]    Verifies all elements on the change password screen
    [Tags]    pentest    smoke
    Open Change Password Popup
    Verify Change Password Popup Displayed
    Verify Text Placeholder    ${textbox_current_password}    Current Password
    Verify Text Placeholder    ${textbox_new_password}    New Password
    Verify Text Placeholder    ${textbox_confirm_password}    Confirm New Password
    Verify OK Button Disabled
    Verify Cancel Button Enabled
    Input Current Password    abc
    Input New Password    abc
    Input Confirm Password    abc
    Verify OK Button Enabled
    Verify Cancel Button Enabled

Verify Cancel Button Functionality
    [Documentation]    Verifies that cancel button closes the popup
    [Tags]    pentest    smoke
    Click To Element    ${button_cancel}
    Verify Element Not Display    ${header_change_password}
    Close Browser

# Password Validation Tests

Verify Password Mismatch
    [Documentation]    Verifies error when new password and confirm password don't match
    [Tags]    pentest    password_validation
    Open Change Password Popup
    Input Current Password    ${password}
    Input New Password    ${valid_password}
    Input Confirm Password    ${valid_password}
    Click OK Button
    Verify Error Message    Those passwords didn't match. Try again.

Verify Password Requirements
    [Documentation]    Verifies various password requirement validations
    [Tags]    pentest    password_validation
    # Test 1: Too short password
    Input New Password    aBC@12
    Input Confirm Password    aBC@12
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 2: Too long password
    Input New Password    ${255_chars_password}
    Input Confirm Password    ${255_chars_password}
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 3: Missing special character
    Input New Password    aBC123452
    Input Confirm Password    aBC123452
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 4: Missing uppercase
    Input New Password    abc123452
    Input Confirm Password    abc123452
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 5: Missing lowercase
    Input New Password    ABC123452
    Input Confirm Password    ABC123452
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 6: Missing number
    Input New Password    aBCEFGHac
    Input Confirm Password    aBCEFGHac
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

    # Test 7: Space in password
    Input Current Password    ${password}
    Input New Password    Abc@123 456
    Input Confirm Password    Abc@123 456
    Click OK Button
    Verify Error Message
    ...    Your password must include 8-255 characters and contain at least one special character, one lowercase, one capital letter and one number.

Verify Password History
    [Documentation]    Verifies that new password cannot be same as recent passwords
    [Tags]    pentest    password_validation
    Input New Password    ${password}
    Input Confirm Password    ${password}
    Click OK Button
    Verify Error Message    New password needs to be different from three latest ones

Verify All Fields Invalid
    [Documentation]    Verifies error when all password fields are invalid
    [Tags]    pentest    password_validation
    Input Current Password    abc@1234
    Input New Password    Abc@12345
    Input Confirm Password    Abc@12346
    Click OK Button
    Verify Error Message    Those passwords didn't match. Try again.

# Security Tests

Verify Incorrect Current Password First Attempt
    [Documentation]    Verifies error message on first incorrect current password attempt
    [Tags]    pentest    password_validation
    Input Current Password    abc@123
    Input New Password    Abc@12345
    Input Confirm Password    Abc@12345
    Click OK Button
    Verify Error Message    Incorrect Password

Verify Incorrect Current Password Second Attempt
    [Documentation]    Verifies error message and timeout on second incorrect attempt
    [Tags]    pentest    password_validation
    Click OK Button
    Verify Error Message    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Timeout    300S

Verify Incorrect Current Password Third Attempt
    [Documentation]    Verifies error message and timeout on third incorrect attempt
    [Tags]    pentest    password_validation
    Click OK Button
    Verify Error Message    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Timeout    900S

Verify Incorrect Current Password Fourth Attempt
    [Documentation]    Verifies error message and timeout on fourth incorrect attempt
    [Tags]    pentest    password_validation
    Click OK Button
    Verify Error Message    You have tried too many times. Please try again later.
    Verify OK Button Disabled With Timeout    1800S

Verify Incorrect Current Password Fifth Attempt
    [Documentation]    Verifies automatic sign out after fifth incorrect attempt
    [Tags]    pentest    password_validation
    Click OK Button
    Verify Message Confirm Bound    You have been automatically signed out for security reasons
    Click OK Popup Confirm
    Close Browser
    ${token}=    Get Authentication Token
    ...    ${urlLogin}
    ...    ${other_username}
    ...    ${other_password}
    ...    ${origin}
    ...    ${version}
    ...    ${environment}
    Update User Status    ${user_id}    2    ${token}

# Functional Tests

Verify Successful Password Change
    [Documentation]    Verifies successful password change flow
    [Tags]    pentest    smoke
    Open Change Password Popup
    Input Current Password    ${password}
    Input New Password    ${valid_password}
    Input Confirm Password    ${valid_password}
    Click OK Button
    Verify Message Confirm Bound    You have been signed out due to changing password!
    Click OK Popup Confirm
    Wait Until Page Contains Element    ${icon_Setting}    timeout=30s
