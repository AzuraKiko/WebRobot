*** Settings ***
Resource    ../../../Page/WebTrading/Pentest/Change_PIN.robot
Resource    ../../../Utils/API.robot
Resource    ../../../Page/WebTrading/Pentest/Create_PIN.robot
# Test Setup    Open Enter Current Pin Popup
# Test Teardown    Close All Browsers


*** Variables ***
${new_pin}          222222
${other_new_pin}    333333
${new_username}     ${EMPTY}
${new_password}     ${EMPTY}
${new_user_id}      ${EMPTY}


*** Test Cases ***
# Current PIN Entry Flow
Check display popup Enter Current Pin
    [Tags]    pentest
    Create New User For Testing
    Open Enter Current Pin Popup    ${new_username}    ${new_password}
    Verify popup Enter Current Pin display

Check Input current PIN. Input correct PIN
    [Tags]    pentest
    Input Current PIN    ${pin}
    Verify popup New Pin display

Check Input current PIN. Input incorrect PIN - 1st time
    [Tags]    pentest
    Click button Back
    Input Current PIN    123456
    Verify message error PIN    1 Failed PIN Attempt

Check Input current PIN. Input incorrect PIN - 2nd time
    [Tags]    pentest
    Input Current PIN    123456
    Wait Until Element Contains    ${error_PIN}    2 Failed PIN Attempts    timeout=30s
    Verify message error PIN    2 Failed PIN Attempts

Check Input current PIN. Input incorrect PIN - 3rd time
    [Tags]    pentest
    Input Current PIN    123456
    Verify message Confirm Bound    You have been automatically signed out for security reasons
    Click OK Popup Confirm
    Verify link [Sign In] display
    Close Browser

# New PIN Entry Flow

Check confirm new PIN different from new PIN
    [Tags]    pentest
    Open Enter Current Pin Popup    ${new_username}    ${new_password}
    Verify popup Enter Current Pin display
    Input Current PIN    ${pin}
    Input New PIN    ${new_pin}
    Verify popup Confirm New Pin display
    Input Confirm New PIN    ${other_new_pin}
    Verify message error match PIN    PIN did not match. Try again
    Close Browser

# OTP Verification Flow

Check Send Code button
    [Tags]    pentest
    Open Enter Current Pin Popup    ${new_username}    ${new_password}
    Verify popup Enter Current Pin display
    Input Current PIN    ${pin}
    Input New PIN    ${new_pin}
    Verify popup Confirm New Pin display
    Input Confirm New PIN    ${new_pin}
    Wait button [Send Code] disable
    Verify button [Send Code] disable in time    60s

Check Confirm button. Input incorrect OTP code - 1st time
    [Tags]    pentest
    Input textbox Enter Code    123456
    Click button Confirm
    Verify message Error Code    Incorrect verification code. Please retry again

Check Confirm button. Input incorrect OTP code - 2nd time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    Wait Until Element Contains
    ...    ${error_Code}
    ...    You have tried too many times. Please try again later.
    ...    timeout=30s
    Verify message Error Code    You have tried too many times. Please try again later.
    Verify button [Confirm] disable in time    300s

Check Confirm button. Input incorrect OTP code - 3rd time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code    You have tried too many times. Please try again later.
    Verify button [Confirm] disable in time    900s

Check Confirm button. Input incorrect OTP code - 4th time
    [Tags]    pentest
    Wait button [Confirm] enable
    Click button Confirm
    Verify message Error Code
    ...    INVALID_TOKEN
    Close Browser

# Successful PIN Change Flow

Verify Successful PIN Change
    [Tags]    pentest
    Open Enter Current Pin Popup    ${new_username}    ${new_password}
    Verify popup Enter Current Pin display
    Input Current PIN    ${pin}
    Input New PIN    ${pin}
    Verify popup Confirm New Pin display
    Input Confirm New PIN    ${pin}
    Sleep    30s
    ${code}=    Set Variable    211322
    Input textbox Enter Code    ${code}
    Sleep    30s
    Click button Confirm
    Verify message Confirm Bound    You have been automatically signed out for security reasons
    Click OK Popup Confirm
    Close Browser
