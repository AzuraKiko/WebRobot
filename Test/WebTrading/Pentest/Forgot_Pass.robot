*** Settings ***
Resource    ../../../Page/WebTrading/Pentest/Forgot_Pass.robot
Resource    ../../../Utils/API.robot


*** Test Cases ***
# Initial Screen Flow
Check open Forgot Password screen
    [Tags]    pentest
    Open Forgot Password Popup
    Verify popup Forgot Password display

# Email Input Flow

Check Email field
    [Tags]    pentest
    Verify placeholder of textbox Email
    Click header Forgot Password
    Verify mess require Email    Email is required
    Close Browser

# Send Code Flow

Check Send Code button
    [Tags]    pentest
    Open Forgot Password Popup
    Verify button [Send code] in Popup Forgot Pass disable
    Input textbox Email in Popup Forgot Pass    ${username}
    Verify button [Send code] in Popup Forgot Pass enable
    Click button [Send Code] in Popup Forgot Pass
    Verify button [Send Code] in Popup Forgot Pass disable in time    60s
    Input textbox Email in Popup Forgot Pass    abc
    Wait button [Send Code] in Forgot Pass enable
    Click button [Send Code] in Popup Forgot Pass
    Verify error message in popup Forgot Pass    Sorry, an unknown error has occurred. Please contact EQUIX Support.

# Code Entry Flow

Check Enter 6 Digit Code
    [Tags]    pentest
    Verify placeholder of textbox Enter Code
    Click textbox [Enter Code] in Popup Forgot Pass
    Click header Forgot Password
    Verify mess require Code    Enter 6 digit code is required

Check Confirm button
    [Tags]    pentest
    Verify button [Confirm] in Popup Forgot Pass disable
    Input textbox Enter Code    123456
    Verify button [Confirm] in Popup Forgot Pass enable
    Close Browser

# Incorrect Code Attempts Flow

Check Input incorrect code. wrong 1st time
    [Tags]    pentest
    Open Forgot Password Popup
    Input textbox Email in Popup Forgot Pass    ${username}
    Click button [Send Code] in Popup Forgot Pass
    ${random_number}=    Generate Random Number    6
    Input textbox Enter Code    ${random_number}
    Click button [Confirm] in Popup Forgot Pass
    Verify error message in popup Forgot Pass    Incorrect verification code. Please retry again

Check Input incorrect code. wrong 2nd time
    [Tags]    pentest
    Click button [Confirm] in Popup Forgot Pass
    Verify error message in popup Forgot Pass    You have tried too many times. Please try again later.
    Verify button [Confirm] in Popup Forgot Pass disable in time    300s

Check Input incorrect code. wrong 3rd time
    [Tags]    pentest
    Click button [Send Code] in Popup Forgot Pass
    ${random_number}=    Generate Random Number    6
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] in Forgot Pass enable
    Click button [Confirm] in Popup Forgot Pass
    Verify error message in popup Forgot Pass    You have tried too many times. Please try again later.
    Verify button [Confirm] in Popup Forgot Pass disable in time    900s

Check Input incorrect code. wrong 4th time
    [Tags]    pentest
    ${random_number}=    Generate Random Number    6
    Click button [Send Code] in Popup Forgot Pass
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] in Forgot Pass enable
    Click button [Confirm] in Popup Forgot Pass
    Verify error message in popup Forgot Pass    You have tried too many times. Please try again later.
    Verify button [Confirm] in Popup Forgot Pass disable in time    1800s

Check Input incorrect code. wrong 5th time or more
    [Tags]    pentest
    ${random_number}=    Generate Random Number    6
    Click button [Send Code] in Popup Forgot Pass
    Input textbox Enter Code    ${random_number}
    Wait button [Confirm] in Forgot Pass enable
    ${expected_message}=    Set Variable
    ...    Your username has been temporarily blocked for security reason. Please contact hello@equix.app for support.

    FOR    ${i}    IN RANGE    20
        ${text}=    Get Element Text By JS    ${error_Mess_Forgot_Pass}
        Log    Current error message: ${text}

        IF    '${text}' == '${expected_message}'    BREAK
        ${pin_code}=    Generate Random Number    6
        Click button [Send Code] in Popup Forgot Pass
        Input textbox Enter Code    ${pin_code}
        Click button [Confirm] in Popup Forgot Pass
        Sleep    1s
    END

    Verify error message in popup Forgot Pass    ${expected_message}
    Close Browser
    ${token}=    Get Authentication Token
    ...    ${urlLogin}
    ...    ${other_username}
    ...    ${other_password}
    ...    ${origin}
    ...    ${version}
    ...    ${environment}
    Update User Status    ${user_id}    2    ${token}

# Successful Forgot Password Flow

Verify Successful Forgot Password
    [Tags]    pentest
    Open Forgot Password Popup
    Verify popup Forgot Password display
    Input textbox Email in Popup Forgot Pass    ${username}
    Input textbox Enter Code    ${pin}
    Click button [Confirm] in Popup Forgot Pass
    Verify message Confirm Bound    You have been signed out due to changing password!
    Close Browser
